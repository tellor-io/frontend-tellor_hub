<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tellor Hub</title>
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="space-station.css" />
    <link rel="icon" type="image/x-icon" href="/drkgrnswsh.png">

    <!-- Load protobuf.js first -->
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

    <script>
      if (typeof crypto.randomUUID !== 'function') {
        crypto.randomUUID = function() {
          return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        };
      }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Removed CryptoJS to avoid hosting security flags -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  </head>

  <body>
    <header>
      <div class="top-left">
        <img src="ellor_hubz.png" alt="Tellor Hub Logo" class="top-left-logo">
      </div>
      <div class="top-right">
        <!-- Wallet Manager Dropdown -->
        <div class="wallet-manager-dropdown">
          <button id="walletManagerToggle" class="wallet-manager-toggle">
            <span class="wallet-manager-text">Connect Wallets</span>
            <span class="wallet-manager-arrow">▼</span>
          </button>
          <div id="walletManagerContent" class="wallet-manager-content">
            <button class="wallet-manager-close" id="walletManagerClose">×</button>
            <!-- Ethereum Wallet Section -->
            <div class="wallet-section">
              <h4 class="wallet-section-title">Ethereum Wallet</h4>
              <div class="wallet-group">
                <button id="walletButton" class="button-style-1" disabled>Connect Ethereum Wallet</button>
                <p class="wallet-balance" id="currentBalance">Balance: 0 TRB</p>
              </div>
              <!-- Network Display and Toggle -->
              <div class="network-group" style="display: none;">
                <span class="network-display" id="network-display">*Connect Wallet to Start*</span>
                <button id="network-toggle-btn" class="toggle-button" style="display: none;">
                  <span id="toggle-text">Switch to Mainnet</span>
                  <span class="toggle-icon">↻</span>
                </button>
              </div>
            </div>
            
            <!-- Cosmos Wallet Section -->
            <div class="wallet-section">
              <h4 class="wallet-section-title">Cosmos Wallet</h4>
              <div class="wallet-group">
                <button id="keplrButton" class="button-style-2" disabled>Connect Cosmos Wallet</button>
                <p class="wallet-balance" id="ethKeplrBalance">Balance: 0 TRB</p>
              </div>
              <!-- Cosmos Network Display and Toggle -->
              <div class="network-group" style="display: none;">
                <span class="network-display" id="cosmos-network-display">*Connect Cosmos Wallet to Start*</span>
                <button id="cosmos-network-toggle-btn" class="toggle-button" style="display: none;">
                  <span id="cosmos-toggle-text">Switch to Mainnet</span>
                  <span class="toggle-icon">↻</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </header>

    <!-- Space Station Hub Container -->
    <div class="space-station-container" id="spaceStationContainer">
      <!-- Initial Hub State -->
      <div class="hub-only-state" id="hubOnlyState">
        <!-- Central Hub -->
        <div class="central-hub">
          <a href="https://explorer.tellor.io" target="_blank" class="hub-core">
            <img src="glwgrnswsh.png" alt="Dark Green Swoosh Hub" class="hub-logo">
          </a>
        </div>

        <!-- Orbiting Pods -->
        <div class="orbit-container">
          <!-- Two Continuous Diagonal Lines -->
          <div class="spoke-line spoke-diagonal-1"></div>
          <div class="spoke-line spoke-diagonal-2"></div>
          
          <!-- Bridge Pod (Consolidated) -->
          <div class="orbiting-pod" data-function="bridge">
            <div class="pod-content">
              <img src="Orb_Bridge_Tellor.png" alt="Bridge" class="pod-icon">
            </div>
          </div>

          <!-- Delegate Pod -->
          <div class="orbiting-pod" data-function="delegate">
            <div class="pod-content">
              <img src="Orb_Delegate.png" alt="Delegate" class="pod-icon">
            </div>
          </div>

          <!-- No-Stake Report Pod -->
          <div class="orbiting-pod" data-function="noStakeReport">
            <div class="pod-content">
              <img src="Orb_Report.png" alt="Report" class="pod-icon">
            </div>
          </div>

          <!-- Dispute Pod -->
          <div class="orbiting-pod" data-function="dispute">
            <div class="pod-content">
              <img src="Orb_Dispute.png" alt="Dispute" class="pod-icon">
            </div>
          </div>
        </div>
      </div>

      <!-- Function Focus State -->
      <div class="function-focus-state" id="functionFocusState" style="display: none;">
        <!-- Side Navigation Menu -->
        <div class="side-nav-menu">
          <div class="side-nav-header">
            <button class="back-to-hub-btn" id="backToHubBtn">
              <span class="back-icon">←</span>
              <span class="back-text">Back to Hub</span>
            </button>
          </div>
          
          <div class="side-nav-options">
            <div class="nav-option" data-function="bridge">
              <img class="nav-option-icon" src="./symbol_bridge_tellor.png" alt="Bridge"/>
              <div class="nav-option-title">Bridge Tokens</div>
            </div>
            
            <div class="nav-option" data-function="delegate">
              <img class="nav-option-icon"src="./symbol_delegate.png" alt="Delegate tokens"/>
              <div class="nav-option-title">Delegate Tokens</div>
            </div>
            
            <div class="nav-option" data-function="noStakeReport">
              <img class="nav-option-icon"src="./symbol_report.png" alt="Bridge to Ethereum"/>
              <div class="nav-option-title">No-Stake Report</div>
            </div>
            
            <div class="nav-option" data-function="dispute">
              <img class="nav-option-icon"src="./symbol_dispute.png" alt="Dispute"/>
              <div class="nav-option-title">Propose Dispute</div>
            </div>
          </div>
        </div>

        <!-- Function Display Area -->
        <div class="function-display-area">
          <div class="function-container">
            <!-- Bridge Section (Consolidated) -->
            <div id="bridgeSection" class="function-section">
              <div class="section-header">
                <div class="bridge-header-container">
                  <h2 id="bridgeTitle">Bridge TRB To Tellor</h2>
                  <div class="bridge-toggle-container">
                    <label class="bridge-toggle-switch">
                      <input type="checkbox" id="bridgeDirectionToggle">
                      <span class="bridge-toggle-slider">
                        <span class="bridge-toggle-label-left">To Tellor</span>
                        <span class="bridge-toggle-label-right">To Ethereum</span>
                      </span>
                    </label>
                  </div>
                </div>
                <p class="section-description" id="bridgeDescription">Transfer your TRB tokens from Ethereum to the Tellor Layer</p>
              </div>
              
              <!-- Bridge to Tellor Content -->
              <div id="bridgeToTellorContent" class="bridge-content">
                <div class="wallet-disclaimer">*Please connect your Ethereum wallet to bridge tokens*</div>
                <w3m-button></w3m-button>
                <div class="balance-info">
                  <div class="input-button-container">
                    <div class="input-with-label">
                      <span class="input-label">TRB</span>
                      <input class="input" type="text" id="stakeAmount" placeholder="0" />
                    </div>
                  </div>
                  <div class="Deposit-limit">
                    <p class="info-text">(Deposit limit: <span id="depositLimit"></span>)</p>
                  </div>
                  <div class="input-button-container">
                    <div class="input-with-label">
                      <input class="input-address" type="text" id="_queryId" placeholder="To address (e.g. tellor1py3fs...)" />
                      <span class="info-icon" data-tooltip="Don't have a tellor prefix address? <a href='https://docs.tellor.io/layer-docs/running-tellor-layer/node-setup' target='_blank'>Click here</a> to learn how to create one">ⓘ</span>
                    </div>
                  </div>
                  <div class="bridge-direction">
                    <button id="approveButton" class="button-style-1" onclick="App.approveDeposit()">Approve Deposit</button>
                    <button id="depositButton" class="button-style-3" onclick="App.depositToLayer()">Bridge to Layer</button>
                  </div>
                </div>
              </div>
              
              <!-- Bridge to Ethereum Content -->
              <div id="bridgeToEthereumContent" class="bridge-content" style="display: none;">
                <div class="wallet-disclaimer">*Please connect both wallets to bridge to Ethereum*</div>
                <div class="wallet-connection-container">
                </div>
                
                <div class="balance-info">
                  <div class="input-button-container">
                    <div class="input-with-label">
                      <span class="input-label">TRB</span>
                      <input class="input" type="text" id="ethStakeAmount" placeholder="0" />
                    </div>
                    <div class="input-with-label">
                      <input class="input-address" type="text" id="ethQueryId" placeholder="To address (e.g. 0x...)" />
                    </div>
                    <button id="withdrawButton" class="button-style-3" onclick="App.withdrawFromLayer()">Request Withdrawal</button>
                  </div>
                </div>
                
                <div class="transactions-container active">
                  <div class="history-header">
                    <h3>Withdrawal Transactions: View & Claim your withdrawal requests and their status</h3>
                  </div>
                  <div class="withdrawal-table-container">
                    <table id="withdrawal-history" class="withdrawal-table">
                      <thead>
                        <tr>
                          <th>Actions</th>
                          <th>ID</th>
                          <th>Sender</th>
                          <th>Recipient</th>
                          <th class="amount-column">Amount (TRB)</th>
                          <th>Time</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="7" class="loading-message">Waiting for wallet connections...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Delegate Section -->
            <div id="delegateSection" class="function-section">
              <div class="section-header">
                <h2>Delegate Tokens</h2>
                <p class="section-description">Stake your TRB tokens with validators to earn rewards</p>
              </div>
              <div class="wallet-disclaimer">*Please connect your Cosmos wallet to delegate tokens*</div>

              <!-- Action Sections (Side by Side) -->
              <div class="action-sections">
                <!-- Delegate Tokens Container -->
                <div class="action-container">
                  <div class="section-header">
                    <h3>Delegate Tokens</h3>
                    <p class="section-description">Stake your TRB tokens with validators</p>
                  </div>

                  <!-- Validator Status Section -->
                  <div class="status-section">
                    <div class="status-header" onclick="App.toggleDelegationsDropdown()">
                      <span>Current Delegations</span>
                      <div class="status-header-controls">
                        <button type="button" id="refreshDelegationsBtn" class="refresh-btn-small" title="Refresh delegations" onclick="event.stopPropagation()">↻</button>
                      </div>
                    </div>
                    <div class="status-content" id="currentDelegationsStatus">
                      <div class="status-loading">Loading...</div>
                    </div>
                    <div class="status-dropdown" id="delegationsDropdown" style="display: none;">
                      <div class="status-dropdown-content" id="delegationsDropdownContent">
                        <!-- Detailed delegations will be populated here -->
                      </div>
                    </div>
                  </div>

                  <div class="action-section">
                    
                    <div class="balance-info">
                        <div class="input-button-container">
                            <div class="input-with-label">
                                <span class="input-label">TRB</span>
                                <input class="input" type="text" id="delegateStakeAmount" placeholder="0" />
                            </div>
                        </div>
                        <div class="input-button-container">
                            <div class="input-with-label">
                                <select class="input-address" id="delegateValidatorDropdown">
                                    <option value="">Select a validator...</option>
                                </select>
                                <button type="button" id="refreshValidatorsBtn" class="refresh-btn" title="Refresh validator list">↻</button>
                                <input type="hidden" id="delegateValidatorAddress" />
                                <span class="info-icon" data-tooltip="Select a validator from the list to delegate your tokens to">ⓘ</span>
                            </div>
                        </div>
                        <div class="bridge-direction">
                            <button id="delegateButton" class="button-style-3" onclick="App.delegateTokens()">Delegate Tokens</button>
                        </div>
                    </div>
                  </div>
                </div>

                <!-- Reporter Selection Container -->
                <div class="action-container">
                  <div class="section-header">
                    <h3>Select Reporter</h3>
                    <p class="section-description">Choose a reporter for data submissions</p>
                  </div>

                  <!-- Reporter Status Section -->
                  <div class="status-section">
                    <div class="status-header">
                      <span>Selected Reporter</span>
                      <button type="button" id="refreshReporterStatusBtn" class="refresh-btn-small" title="Refresh reporter status">↻</button>
                    </div>
                    <div class="status-content" id="currentReporterStatus">
                      <div class="status-loading">Loading...</div>
                    </div>
                  </div>

                  <div class="action-section">
                    
                    <div class="balance-info">
                        <div class="input-button-container">
                            <div class="input-with-label">
                                <span class="input-label">TRB *</span>
                                <input class="input" type="text" id="reporterStakeAmount" placeholder="Enter TRB amount" required />
                            </div>
                        </div>
                        <div class="input-button-container">
                            <div class="input-with-label">
                                <select class="input-address" id="reporterDropdown">
                                    <option value="">Select a reporter...</option>
                                </select>
                                <button type="button" id="refreshReportersBtn" class="refresh-btn" title="Refresh reporter list">↻</button>
                                <input type="hidden" id="selectedReporterAddress" />
                                <span class="info-icon" data-tooltip="Select a reporter from the list to handle data submissions.">ⓘ</span>
                            </div>
                        </div>
                        <div class="bridge-direction">
                            <button id="selectReporterButton" class="button-style-3" onclick="App.selectReporter()">Select Reporter</button>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No-Stake Report Section -->
            <div id="noStakeReportSection" class="function-section">
              <div class="section-header">
                <h2>No-Stake Report</h2>
                <p class="section-description">Submit data reports without requiring staked tokens</p>
              </div>
              <div class="wallet-disclaimer">*Please connect your Cosmos wallet*</div>
                              <div class="balance-info no-stake-horizontal-layout">
                    <div class="no-stake-row">
                        <div class="no-stake-left-column">
                            <div class="input-with-label no-stake-value-container">
                                <span class="input-label">Value (Hex)</span>
                                <input class="no-stake-input" type="text" id="noStakeValue" placeholder="0x..." />
                            </div>
                            <div class="input-with-label no-stake-query-container">
                                <span class="input-label">Query Data (Hex)</span>
                                <textarea class="no-stake-input" id="noStakeQueryData" placeholder="0x..." rows="6"></textarea>
                            </div>
                        </div>
                        <div class="no-stake-submit-container">
                            <button id="submitNoStakeReportBtn" class="button-style-3" onclick="App.submitNoStakeReport()">Submit Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispute Section -->
            <div id="disputeSection" class="function-section">
              <div class="section-header">
                <h2>Dispute Management</h2>
                <p class="section-description">Propose disputes and vote on existing disputes</p>
              </div>
              
              <!-- Tab Navigation -->
              <div class="dispute-tabs">
                <button class="dispute-tab-btn active" onclick="switchDisputeTab('proposeDisputeTab')">Propose Dispute</button>
                <button class="dispute-tab-btn" onclick="switchDisputeTab('addFeeDisputeTab')">Add Fee</button>
                <button class="dispute-tab-btn" onclick="switchDisputeTab('voteDisputeTab')">Vote on Dispute</button>
                <button class="dispute-tab-btn" onclick="switchDisputeTab('queryDisputeTab')">Query Dispute</button>
              </div>
              
              <!-- Propose Dispute Tab -->
              <div class="dispute-tab-content active" id="proposeDisputeTab">
                <div class="dispute-header-row">
                  <h3 class="text-lg font-semibold mb-4">Propose New Dispute</h3>
                  <div class="wallet-disclaimer-inline">*Please connect your Cosmos wallet*</div>
                </div>
                <div class="balance-info dispute-horizontal-layout">
                  <div class="dispute-row">
                    <div class="dispute-left-column">
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Disputed Reporter Address</span>
                        <input class="dispute-input" type="text" id="disputedReporter" placeholder="tellor1..." />
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Report Meta ID</span>
                        <input class="dispute-input" type="text" id="reportMetaId" placeholder="Enter report meta ID" />
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Report Query ID</span>
                        <input class="dispute-input" type="text" id="reportQueryId" placeholder="Enter report query ID" />
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Dispute Category</span>
                        <select class="dispute-input" id="disputeCategory">
                          <option value="warning">warning</option>
                          <option value="minor">minor</option>
                          <option value="major">major</option>
                        </select>
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Fee (loya)</span>
                        <input class="dispute-input" type="text" id="disputeFee" placeholder="0" />
                      </div>
                      <div class="input-with-label dispute-checkbox-container">
                        <label class="checkbox-label">
                          <input type="checkbox" id="payFromBond" />
                          <span class="checkbox-text">Pay from bond</span>
                        </label>
                      </div>
                    </div>
                    <div class="dispute-submit-container">
                      <button id="proposeDisputeBtn" class="button-style-3" onclick="App.proposeDispute()">Propose Dispute</button>
                      <!-- Subtle scroll indicator positioned next to button -->
                      <div class="scroll-indicator-subtle" id="proposeDisputeScrollIndicator">
                        <div class="scroll-indicator-subtle-content">
                          <span class="scroll-indicator-dots">⋯</span>
                          <span class="scroll-indicator-text-subtle">Scroll down for more fields</span>
                          <span class="scroll-indicator-arrow-subtle">↓</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Fee to Dispute Tab -->
              <div class="dispute-tab-content" id="addFeeDisputeTab">
                <h3 class="text-lg font-semibold mb-4">Add Fee to Dispute</h3>
                <div class="wallet-disclaimer">*Please connect your Cosmos wallet*</div>
                <div class="balance-info dispute-horizontal-layout">
                  <div class="dispute-row">
                    <div class="dispute-left-column">
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Dispute ID</span>
                        <input class="dispute-input" type="number" id="addFeeDisputeId" placeholder="Enter dispute ID" />
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Amount (TRB)</span>
                        <input class="dispute-input" type="number" id="addFeeAmount" placeholder="Enter amount in TRB" step="0.000001" />
                      </div>
                      <div class="dispute-checkbox-container">
                        <label class="checkbox-label">
                          <input type="checkbox" id="addFeePayFromBond" />
                          <span class="checkbox-text">Pay from bond</span>
                        </label>
                        <div class="help-text text-xs text-gray-500 mt-1">
                          Check to pay from staked bond. Disputed reporters cannot use bond funds.
                        </div>
                      </div>
                    </div>
                    <div class="dispute-submit-container">
                      <button id="addFeeDisputeBtn" class="button-style-3" onclick="App.addFeeToDispute()">Add Fee</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Vote on Dispute Tab -->
              <div class="dispute-tab-content" id="voteDisputeTab">
                <h3 class="text-lg font-semibold mb-4">Vote on Dispute</h3>
                <div class="wallet-disclaimer">*Please connect your Cosmos wallet*</div>
                <div class="balance-info dispute-horizontal-layout">
                  <div id="votingPowerIndicator" class="voting-power-indicator" style="display: none;"></div>
                  
                  <div class="dispute-row">
                    <div class="dispute-left-column">
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Dispute ID</span>
                        <select class="dispute-input" id="voteDisputeId">
                          <option value="">Select a dispute</option>
                        </select>
                        <button type="button" class="refresh-btn" onclick="App.loadOpenDisputes()" title="Refresh open disputes">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 4v6h6"></path>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                          </svg>
                        </button>
                      </div>
                      <div class="input-with-label dispute-input-container">
                        <span class="input-label">Vote Choice</span>
                        <select class="dispute-input" id="voteChoice">
                          <option value="">Select vote</option>
                          <option value="vote-support">Support</option>
                          <option value="vote-against">Against</option>
                          <option value="vote-invalid">Invalid</option>
                        </select>
                      </div>
                    </div>
                    <div class="dispute-submit-container">
                      <button id="voteDisputeBtn" class="button-style-3" onclick="App.voteOnDispute()">Submit Vote</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Query Dispute Tab -->
              <div class="dispute-tab-content" id="queryDisputeTab">
                <div class="disputes-query-header">
                  <h3 class="text-lg font-semibold mb-4">All Disputes</h3>
                  <div class="disputes-controls">
                    <button class="refresh-btn" onclick="App.loadAllDisputes()" title="Refresh disputes">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6"></path>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                      </svg>
                    </button>
                    <div id="disputesTotalCount" class="disputes-count"></div>
                  </div>
                </div>
                
                <div id="disputesLoading" class="disputes-loading" style="display: none;">
                  Loading disputes...
                </div>
                
                <div id="disputesError" class="disputes-error" style="display: none;"></div>
                
                <div id="disputesTable" class="disputes-table-container" style="display: none;">
                  <table class="disputes-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Category</th>
                        <th>Reporter</th>
                        <th>Query ID</th>
                        <th>Fees (TRB)</th>
                        <th>Dates</th>
                        <th>Block</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="disputesTableBody">
                      <!-- Disputes will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <a target="_blank" href="https://github.com/tellor-io/frontend-layerbridgebutton" class="frontend-code-link">Front-End code</a>
    

    <script src="./extensions/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
    <!-- Load app.js as a module only once -->
    <script type="module">
      // Define a global variable to track CosmJS loading
      window.cosmjsLoaded = false;
      
      // Function to load a single script
      function loadScript(src, type = 'text/javascript') {
        return new Promise((resolve, reject) => {
          // Skip if app.js is already loaded
          if (src === 'app.js' && document.querySelector('script[src="app.js"]')) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.type = type;
          script.onload = () => {
            // For app.js, wait a tick to ensure App is defined
            if (src === 'app.js') {
              setTimeout(resolve, 0);
            } else {
              resolve();
            }
          };
          script.onerror = () => reject(new Error(`Failed to load ${src}`));
          document.head.appendChild(script);
        });
      }
      
      // Function to load CosmJS scripts
      async function loadCosmJS() {
        try {
          const scripts = [
            './extensions/cosmjs/encoding.js',
            './extensions/cosmjs/math.js',
            './extensions/cosmjs/proto.js',
            './extensions/cosmjs/proto-signing.js',
            './extensions/cosmjs/stargate.js'
          ];

          // Load scripts sequentially
          for (const src of scripts) {
            await loadScript(src);
          }

          // Verify CosmJS is loaded
          if (typeof window.cosmjs === 'undefined' || typeof window.cosmjs.stargate === 'undefined') {
            throw new Error('CosmJS failed to initialize properly');
          }

          window.cosmjsLoaded = true;
          return true;
        } catch (error) {
          console.error('Error loading CosmJS:', error);
          return false;
        }
      }

      // Function to load wallet adapter scripts
      async function loadWalletAdapters() {
        try {
          const scripts = [
            './js/walletAdapter.js',
            './js/walletModal.js',
            './js/ethereumWalletAdapter.js',
            './js/ethereumWalletModal.js'
          ];

          // Load scripts sequentially
          for (const src of scripts) {
            await loadScript(src);
          }

          // Verify wallet adapters are loaded
          if (typeof window.cosmosWalletAdapter === 'undefined') {
            console.warn('Cosmos wallet adapter not loaded - falling back to Keplr-only mode');
          }
          
          if (typeof window.ethereumWalletAdapter === 'undefined') {
            console.warn('Ethereum wallet adapter not loaded - falling back to MetaMask-only mode');
          }

          return true;
        } catch (error) {
          console.error('Error loading wallet adapters:', error);
          return false;
        }
      }

      // Load CosmJS and wallet adapters, then initialize the app
      Promise.all([
        loadCosmJS(),
        loadWalletAdapters()
      ])
        .then(([cosmjsSuccess, adapterSuccess]) => {
          // Allow app to initialize even if CosmJS fails (delegate section doesn't need it)
          if (!cosmjsSuccess) {
            console.warn('CosmJS failed to load - some Cosmos functions may not work, but app will continue');
          }
          
          // Load app.js as a module
          return loadScript('app.js', 'module');
        })
        .then(() => {
          // Wait for App to be defined
          return new Promise((resolve) => {
            const checkApp = () => {
              if (typeof window.App !== 'undefined') {
                resolve();
              } else {
                setTimeout(checkApp, 100);
              }
            };
            checkApp();
          });
        })
        .then(() => {
          // Initialize the app after everything is loaded
          return window.App.init();
        })
        .catch(error => {
          console.error('Initialization error:', error);
          const walletButton = document.getElementById('walletButton');
          if (walletButton) {
            walletButton.textContent = 'Error: Please refresh page';
            walletButton.disabled = true;
          }
        });
    </script>
    <script>
      // Simple test to see if the button exists
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - testing wallet manager button...');
        const testButton = document.getElementById('walletManagerToggle');
        console.log('Wallet manager button found:', !!testButton);
        if (testButton) {
          console.log('Button text:', testButton.textContent);
          testButton.addEventListener('click', function() {
            console.log('Button clicked via DOMContentLoaded handler');
          });
        }
      });
      
      document.addEventListener('DOMContentLoaded', function() {
        const infoIcons = document.querySelectorAll('.info-icon');
        let tooltipTimer;
        
        // Function to hide all tooltips
        function hideAllTooltips() {
            clearTimeout(tooltipTimer);
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                tooltip.style.display = 'none';
            });
            // Reset the TRB price tooltip using the global function
            if (window.resetTrbPriceTooltip) {
                window.resetTrbPriceTooltip();
            }
        }
        
        // Add pod navigation handlers
        const orbitingPods = document.querySelectorAll('.orbiting-pod');
        const orbitContainer = document.querySelector('.orbit-container');
        
        orbitingPods.forEach(pod => {
          // Add hover events to pause/resume space station
          pod.addEventListener('mouseenter', function() {
            orbitContainer.classList.add('paused');
          });
          
          pod.addEventListener('mouseleave', function() {
            orbitContainer.classList.remove('paused');
          });
          
          pod.addEventListener('click', function() {
            const functionType = this.getAttribute('data-function');
            
            // Switch to function focus state
            document.getElementById('hubOnlyState').style.display = 'none';
            document.getElementById('functionFocusState').style.display = 'flex';
            
            // Show corresponding section
            let sectionId = '';
            switch(functionType) {
              case 'bridge':
                sectionId = 'bridgeSection';
                break;
              case 'delegate':
                sectionId = 'delegateSection';
                break;
              case 'noStakeReport':
                sectionId = 'noStakeReportSection';
                break;
              case 'dispute':
                sectionId = 'disputeSection';
                break;
            }
            
            if (sectionId) {
              document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
              document.getElementById(sectionId).classList.add('active');
              
              // Update bridge direction for proper button state management
              if (window.App && window.App.switchBridgeDirection) {
                window.App.switchBridgeDirection(functionType);
              }
              
              // Hide TRB price tooltip immediately when switching sections
              if (window.hideTrbPriceTooltip) {
                window.hideTrbPriceTooltip();
              }
              if (window.hideTrbPriceTooltip) {
                window.hideTrbPriceTooltip();
              }
              
              // For relevant sections, check if there's a value and show tooltip if appropriate
              if (functionType !== 'noStakeReport' && functionType !== 'dispute') {
                setTimeout(() => {
                  if (window.App && window.App.currentBridgeDirection) {
                    const activeInput = window.App.currentBridgeDirection === 'layer' ? 
                      document.getElementById('stakeAmount') : 
                      document.getElementById('ethStakeAmount');
                    if (activeInput && activeInput.value && parseFloat(activeInput.value) > 0) {
                      // Trigger tooltip update if there's a value
                      if (window.App.updateTooltip) {
                        window.App.updateTooltip();
                      }
                    }
                  }
                }, 200);
              }
              
              // Update withdrawal history when bridge to ethereum section is shown
              if (functionType === 'bridgeToEth') {
                // Update the withdrawal history in the integrated table
                if (window.App && window.App.updateWithdrawalHistory) {
                  setTimeout(() => {
                    window.App.updateWithdrawalHistory();
                  }, 100);
                }
              }
            }
            
            // Update side nav active state
            document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector(`.nav-option[data-function="${functionType}"]`).classList.add('active');
            
            // Hide all tooltips when switching functions
            hideAllTooltips();
          });
        });
        
        // Add back to hub button handler
        document.getElementById('backToHubBtn').addEventListener('click', function() {
          document.getElementById('hubOnlyState').style.display = 'flex';
          document.getElementById('functionFocusState').style.display = 'none';
          
          // Reset all active states
          document.querySelectorAll('.orbiting-pod').forEach(p => p.classList.remove('active'));
          document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
          document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
          
          // Hide TRB price tooltip when going back to hub
          if (window.hideTrbPriceTooltip) {
            window.hideTrbPriceTooltip();
          }
        });
        
        // Add side nav option handlers
        document.querySelectorAll('.nav-option').forEach(option => {
          option.addEventListener('click', function() {
            const functionType = this.getAttribute('data-function');
            
            // Update active nav option
            document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding section
            let sectionId = '';
            switch(functionType) {
              case 'bridge':
                sectionId = 'bridgeSection';
                break;
              case 'delegate':
                sectionId = 'delegateSection';
                break;
              case 'noStakeReport':
                sectionId = 'noStakeReportSection';
                break;
              case 'dispute':
                sectionId = 'disputeSection';
                break;
            }
            
            if (sectionId) {
              document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
              document.getElementById(sectionId).classList.add('active');
              
              // Update bridge direction for proper button state management
              if (window.App && window.App.switchBridgeDirection) {
                window.App.switchBridgeDirection(functionType);
              }
              
              // Hide TRB price tooltip immediately when switching sections
              if (window.hideTrbPriceTooltip) {
                window.hideTrbPriceTooltip();
              }
              if (window.hideTrbPriceTooltip) {
                window.hideTrbPriceTooltip();
              }
              
              // For relevant sections, check if there's a value and show tooltip if appropriate
              if (functionType !== 'noStakeReport' && functionType !== 'dispute') {
                setTimeout(() => {
                  if (window.App && window.App.currentBridgeDirection) {
                    const activeInput = window.App.currentBridgeDirection === 'layer' ? 
                      document.getElementById('stakeAmount') : 
                      document.getElementById('ethStakeAmount');
                    if (activeInput && activeInput.value && parseFloat(activeInput.value) > 0) {
                      // Trigger tooltip update if there's a value
                      if (window.App.updateTooltip) {
                        window.App.updateTooltip();
                      }
                    }
                  }
                }, 200);
              }
              
              // Update withdrawal history when bridge to ethereum section is shown
              if (functionType === 'bridgeToEth') {
                // Update the withdrawal history in the integrated table
                if (window.App && window.App.updateWithdrawalHistory) {
                  setTimeout(() => {
                    window.App.updateWithdrawalHistory();
                  }, 100);
                }
              }
            }
            
            // Hide all tooltips when switching functions
            hideAllTooltips();
          });
        });
        
        infoIcons.forEach(icon => {
            // Add tooltip functionality to icons in the Bridge section and Delegate section
            if (icon.closest('#bridgeSection') || icon.closest('#delegateSection')) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = icon.getAttribute('data-tooltip');
                document.body.appendChild(tooltip);
                
                // Show tooltip on hover
                icon.addEventListener('mouseenter', function(e) {
                    // Only show tooltip if we're in the Bridge section or Delegate section
                    if (!document.getElementById('bridgeSection').classList.contains('active') && 
                        !document.getElementById('delegateSection').classList.contains('active')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    clearTimeout(tooltipTimer);
                    
                    // Hide all other tooltips
                    hideAllTooltips();
                    
                    // Calculate position
                    const iconRect = icon.getBoundingClientRect();
                    
                    // Check if this is the reporter tooltip and position to the left by default
                    const isReporterTooltip = icon.closest('#delegateSection') && 
                                             icon.getAttribute('data-tooltip').includes('reporter');
                    
                    // Show tooltip first to get proper dimensions
                    tooltip.style.display = 'block';
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    // Position tooltip - left for reporter, right for others
                    let left = isReporterTooltip ? 
                        iconRect.left - tooltipRect.width - 10 : 
                        iconRect.right + 10;
                    let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                    
                    // Ensure tooltip stays within viewport
                    if (isReporterTooltip) {
                        // For reporter tooltip, check if it goes off the left edge
                        if (left < 10) {
                            left = iconRect.right + 10; // Fallback to right
                        }
                    } else {
                        // For other tooltips, check if it goes off the right edge
                        if (left + tooltipRect.width > window.innerWidth) {
                            left = iconRect.left - tooltipRect.width - 10;
                        }
                    }
                    if (top + tooltipRect.height > window.innerHeight) {
                        top = window.innerHeight - tooltipRect.height - 10;
                    }
                    if (top < 10) {
                        top = 10;
                    }
                    
                    // Apply position
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.display = 'block';
                });
                
                // Hide tooltip when mouse leaves
                icon.addEventListener('mouseleave', function(e) {
                    e.stopPropagation();
                    tooltipTimer = setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 500);
                });
                
                // Also handle click for mobile devices
                icon.addEventListener('click', function(e) {
                    // Only show tooltip if we're in the Bridge section or Delegate section
                    if (!document.getElementById('bridgeSection').classList.contains('active') && 
                        !document.getElementById('delegateSection').classList.contains('active')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    clearTimeout(tooltipTimer);
                    
                    // Calculate position for click
                    const iconRect = icon.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    let left = iconRect.right + 10;
                    let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                    
                    // Ensure tooltip stays within viewport
                    if (left + tooltipRect.width > window.innerWidth) {
                        left = iconRect.left - tooltipRect.width - 10;
                    }
                    if (top + tooltipRect.height > window.innerHeight) {
                        top = window.innerHeight - tooltipRect.height - 10;
                    }
                    if (top < 10) {
                        top = 10;
                    }
                    
                    // Toggle tooltip visibility
                    if (tooltip.style.display === 'block') {
                        tooltip.style.display = 'none';
                    } else {
                        // Hide all other tooltips
                        hideAllTooltips();
                        
                        // Show this tooltip
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                        tooltip.style.display = 'block';
                        
                        // Set timer to hide tooltip after 3 seconds on mobile
                        tooltipTimer = setTimeout(() => {
                            tooltip.style.display = 'none';
                        }, 3000);
                    }
                });
            }
        });
        
        // Hide tooltips when clicking anywhere else
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.info-icon') && !e.target.closest('.tooltip')) {
                hideAllTooltips();
            }
        });

        // Update tooltip position on window resize
        window.addEventListener('resize', function() {
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                if (tooltip.style.display === 'block') {
                    const icon = document.querySelector('.info-icon[data-tooltip="' + tooltip.innerHTML + '"]');
                    if (icon && (document.getElementById('bridgeSection').classList.contains('active') || 
                                document.getElementById('delegateSection').classList.contains('active'))) {
                        const iconRect = icon.getBoundingClientRect();
                        
                        // Check if this is the reporter tooltip and position to the left by default
                        const isReporterTooltip = icon.closest('#delegateSection') && 
                                                 icon.getAttribute('data-tooltip').includes('reporter');
                        
                        // Get tooltip dimensions (it should already be visible)
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        // Position tooltip - left for reporter, right for others
                        let left = isReporterTooltip ? 
                            iconRect.left - tooltipRect.width - 10 : 
                            iconRect.right + 10;
                        let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                        
                        // Ensure tooltip stays within viewport
                        if (isReporterTooltip) {
                            // For reporter tooltip, check if it goes off the left edge
                            if (left < 10) {
                                left = iconRect.right + 10; // Fallback to right
                            }
                        } else {
                            // For other tooltips, check if it goes off the right edge
                            if (left + tooltipRect.width > window.innerWidth) {
                                left = iconRect.left - tooltipRect.width - 10;
                            }
                        }
                        if (top + tooltipRect.height > window.innerHeight) {
                            top = window.innerHeight - tooltipRect.height - 10;
                        }
                        if (top < 10) {
                            top = 10;
                        }
                        
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                }
            });
        });

        // Add event listeners for input fields
        const stakeAmountInput = document.getElementById('stakeAmount');

        stakeAmountInput.addEventListener('input', async function() {
          const amount = parseFloat(this.value) || 0;
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          
          // Check if App is available and has the function
          if (window.App && window.App.hideBalanceErrorPopup) {
            window.App.hideBalanceErrorPopup();
          }
          
          if (amount > 0) {
            const hasBalance = await checkBalance(amount);
            if (!hasBalance) {
              approveButton.disabled = true;
              depositButton.disabled = true;
              return;
            }
          }
          
          checkAllowance();
        });

        async function checkBalance(amount) {
          // Check if App is available and has the function
          if (window.App && window.App.checkBalance) {
            return await window.App.checkBalance(amount);
          }
          
          // Fallback implementation
          try {
            if (!window.App || !window.App.isConnected) {
              return false;
            }
            
            const balance = await window.App.contracts.Token.methods.balanceOf(window.App.account).call();
            const balanceInEther = window.App.web3.utils.fromWei(balance, 'ether');
            return parseFloat(balanceInEther) >= amount;
          } catch (error) {
            console.error('Error checking balance:', error);
            return false;
          }
        }

        async function checkAllowance() {
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          const withdrawButton = document.getElementById('withdrawButton');
          const stakeAmount = parseFloat(stakeAmountInput.value) || 0;

          if (isNaN(stakeAmount) || stakeAmount <= 0) {
            approveButton.disabled = true;
            depositButton.disabled = true;
            withdrawButton.disabled = true;
            return;
          }

          // Handle Keplr wallet
          if (App.isKeplrConnected) {
            approveButton.style.display = 'none';
            depositButton.style.display = 'none';
            withdrawButton.disabled = false;
            return;
          }

          // Handle MetaMask wallet
          try {
            const allowance = await App.getAllowance();
            const stakeAmountWei = App.web3.utils.toWei(stakeAmount.toString(), 'ether');
            
            if (App.web3.utils.toBN(stakeAmountWei).gt(App.web3.utils.toBN(allowance))) {
              // Need approval - enable approve button, disable deposit button
              approveButton.disabled = false;
              depositButton.disabled = true;
            } else {
              // Already approved - disable approve button, enable deposit button
              approveButton.disabled = true;
              depositButton.disabled = false;
            }
          } catch (error) {
            console.error('Error checking allowance:', error);
            approveButton.disabled = true;
            depositButton.disabled = true;
          }
        }

        // Hide all tooltips function
        function hideAllTooltips() {
          document.querySelectorAll('.tooltip').forEach(tooltip => {
            tooltip.style.display = 'none';
          });
        }

        // No-stake reporting is now integrated with the existing wallet manager
        
        // Wait for App to be initialized before checking allowance
        function waitForAppAndInitialize() {
            if (window.App && typeof window.App.getAllowance === 'function') {
                checkAllowance();
            } else {
                setTimeout(waitForAppAndInitialize, 500);
            }
        }
        
        // Start waiting for App
        waitForAppAndInitialize();

        // Bridge toggle functionality
        const bridgeToggle = document.getElementById('bridgeDirectionToggle');
        const bridgeTitle = document.getElementById('bridgeTitle');
        const bridgeDescription = document.getElementById('bridgeDescription');
        const bridgeToTellorContent = document.getElementById('bridgeToTellorContent');
        const bridgeToEthereumContent = document.getElementById('bridgeToEthereumContent');

        if (bridgeToggle) {
          bridgeToggle.addEventListener('change', function() {
            if (this.checked) {
              // Switch to Bridge to Ethereum
              bridgeTitle.textContent = 'Bridge TRB to Ethereum';
              bridgeDescription.textContent = 'Withdraw your TRB tokens from Tellor back to Ethereum';
              bridgeToTellorContent.style.display = 'none';
              bridgeToEthereumContent.style.display = 'block';
              
              // Update withdrawal history when switching to Ethereum bridge
              if (window.App && window.App.updateWithdrawalHistory) {
                setTimeout(() => {
                  window.App.updateWithdrawalHistory();
                }, 100);
              }
            } else {
              // Switch to Bridge to Tellor
              bridgeTitle.textContent = 'Bridge TRB';
              bridgeDescription.textContent = 'Transfer your TRB tokens from Ethereum to the Tellor';
              bridgeToTellorContent.style.display = 'block';
              bridgeToEthereumContent.style.display = 'none';
            }
          });
        }

        // Dispute tab switching function
        function switchDisputeTab(tabId) {
          // Hide all tab contents
          document.querySelectorAll('.dispute-tab-content').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Remove active class from all tab buttons
          document.querySelectorAll('.dispute-tab-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Show selected tab content
          document.getElementById(tabId).classList.add('active');
          
          // Add active class to clicked button
          event.target.classList.add('active');
        }
      });
    </script>

    <!-- Global dispute tab switching function -->
    <script>
      // Global function for dispute tab switching
      // Helper function to check if scroll indicator should be shown
      window.checkScrollIndicatorVisibility = function() {
        const proposeTab = document.getElementById('proposeDisputeTab');
        const scrollIndicator = document.getElementById('proposeDisputeScrollIndicator');
        
        if (!proposeTab || !scrollIndicator) {
          return;
        }
        
        // Only proceed if propose dispute tab is active
        if (!proposeTab.classList.contains('active')) {
          return;
        }
        
        // Get the submit button (last element that needs to be visible)
        const submitButton = document.getElementById('proposeDisputeBtn');
        if (!submitButton) {
          return;
        }
        
        // Check if submit button is visible in viewport
        const rect = submitButton.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // If submit button is visible, hide the indicator
        if (rect.top <= viewportHeight - 50) {
          scrollIndicator.style.display = 'none';
        } else {
          // If submit button is not visible, show the indicator
          scrollIndicator.style.display = 'block';
          scrollIndicator.style.opacity = '0.7';
        }
      };

      window.switchDisputeTab = function(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.dispute-tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.dispute-tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
        
        // Handle scroll indicator for propose dispute tab
        if (tabId === 'proposeDisputeTab') {
          // Check visibility after a short delay to ensure DOM is updated
          setTimeout(() => {
            checkScrollIndicatorVisibility();
            
            // Add event listeners
            const functionDisplayArea = document.querySelector('.function-display-area');
            if (functionDisplayArea) {
              functionDisplayArea.removeEventListener('scroll', checkScrollIndicatorVisibility);
              functionDisplayArea.addEventListener('scroll', checkScrollIndicatorVisibility);
            }
            
            window.removeEventListener('resize', checkScrollIndicatorVisibility);
            window.addEventListener('resize', checkScrollIndicatorVisibility);
          }, 200);
        }
        
        // Auto-load open disputes and check voting power when Vote on Dispute tab is selected (only if wallet is connected)
        if (tabId === 'voteDisputeTab') {
          setTimeout(async () => {
            // Check if wallet is connected before loading disputes
            if (window.disputeProposer) {
              const walletStatus = await window.disputeProposer.getWalletStatus();
              if (walletStatus.isConnected) {
                if (window.App && window.App.loadOpenDisputes) {
                  window.App.loadOpenDisputes();
                }
                if (window.App && window.App.checkVotingPower) {
                  window.App.checkVotingPower();
                }
              }
            }
          }, 100);
        }
        
        // Auto-load all disputes when Query Dispute tab is selected (always try, will check wallet inside)
        if (tabId === 'queryDisputeTab') {
          setTimeout(() => {
            if (window.App && window.App.loadAllDisputes) {
              window.App.loadAllDisputes();
            }
          }, 100);
        }
      };
    </script>
    <script src="./js/noStake.js"></script>
    <script src="./js/dispute.js"></script>
  </body>
</html>